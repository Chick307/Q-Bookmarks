<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script type="text/javascript" src="scripts/pref.js"></script>
<script type="text/javascript">

var allBookmarks = {}, bookmarkBar, otherBookmarks;

function BookmarkItem(info, parent){
	var title = info.title,
		url = info.url;
	
	Object.defineProperties(this, {
		id: {value: info.id},
		title: {
			get: function(){
				return title;
			},
			set: function(value){
				chrome.bookmarks.update(this.id, {
					title: title = value
				});
			}
		},
		url: {
			get: function(){
				return url;
			},
			set: function(value){
				chrome.bookmarks.update(this.id, {
					url: url = value
				});
			}
		},
		favicon: {
			get: function(){
				return 'chrome://favicon/' + url;
			}
		},
		parent: {
			get: function(){
				return parent;
			},
			set: function(value){
				parent = value
			}
		},
		remove: {
			value: function(){
				chrome.bookmarks.remove(this.id);
			}
		},
		isItem: {value: true},
		isFolder: {value: false}
	});
	
	allBookmarks[info.id] = this;
}

function BookmarkFolder(info, parent){
	var children_ = info.children || [];
	var title = info.title,
		url = info.url,
		children = children_.map(function(child){
			length++;
			if(child.url){
				return new BookmarkItem(child, this);
			}else{
				return new BookmarkFolder(child, this);
			}
		}, this),
		length = 0;
	
	Object.defineProperties(this, {
		id: {value: info.id},
		title: {
			get: function(){
				return title;
			},
			set: function(value){
				title = value;
			}
		},
		parent: {
			get: function(){
				return parent;
			},
			set: function(value){
				parent = value
			}
		},
		children: {
			get: function(){
				return children.slice();
			}
		},
		length: {
			get: function(){
				return length;
			}
		},
		remove: {
			value: function(){
				chrome.bookmarks.removeTree(this.id);
			}
		},
		search: {
			value: function(text){
				var result = [];
				children.forEach(function(child){
					if(child.isFolder){
						child.search(text).forEach(function(r){
							result.push(r);
						});
					}else if(child.title.toLowerCase().indexOf(text) !== -1 ||
						child.url.toLowerCase().indexOf(text) !== -1){
						result.push(child);
					}
				});
				return result;
			}
		},
		isItem: {value: false},
		isFolder: {value: true},
		onChildrenReordered: {
			value: function(reorderInfo){
				children = reorderInfo.map(function(id){
					return allBookmarks[id];
				});
			}
		},
		onChildCreate: {
			value: function(node){
				children.push(node);
			}
		},
		onChildMoved: {
			value: function(id){
				children = children.filter(function(node){
					return node.id !== id;
				});
			}
		},
		onMovedTo: {
			value: function(id, index){
				children.splice(index, 0, allBookmarks[id]);
			}
		}
	});
	
	allBookmarks[info.id] = this;
}

chrome.bookmarks.getTree(function(tree){
	var root = tree[0];
	bookmarkBar = new BookmarkFolder(root.children[0]);
	otherBookmarks = new BookmarkFolder(root.children[1]);
});

chrome.bookmarks.onChildrenReordered.addListener(function(id, reorderInfo){
	allBookmarks[id].onChildrenReordered(reorderInfo);
});

chrome.bookmarks.onCreated.addListener(function(id, bookmark){
	var node, parent = allBookmarks[bookmark.parentId];
	if(bookmark.url){
		node = new BookmarkItem(bookmark, parent);
	}else{
		node = new BookmarkFolder(bookmark, parent);
	}
	parent.onChildCreate(node);
});

chrome.bookmarks.onMoved.addListener(function(id, moveInfo){
	var parent = allBookmarks[moveInfo.parentId],
		oldParent = allBookmarks[moveInfo.oldParentId];
	oldParent.onChildMoved(id);
	parent.onMovedTo(id, moveInfo.index);
});

chrome.bookmarks.onRemoved.addListener(function(id, removeInfo){
	var parent = allBookmarks[removeInfo.parentId];
	parent.onChildMoved(id);
});

chrome.bookmarks.onChanged.addListener(function(id, changeInfo){
	var node = allBookmarks[id];
	
	if(changeInfo.title != null){
		node.title = changeInfo.title;
	}
	
	if(changeInfo.url != null){
		node.url = changeInfo.url;
	}
});


// Omniboxからの検索
function search(text){
	text = text.toLowerCase();
	var result = bookmarkBar.search(text);
	return result.concat(otherBookmarks.search(text));
}

chrome.omnibox.setDefaultSuggestion({
	description: 'Q Bookmarks : Search "%s"'
});

chrome.omnibox.onInputChanged.addListener(function(text, suggest){
	if(!text)
		return;
	var result = search(text).map(function(bookmark){
		return {
			content: bookmark.url,
			description: 'Q Bookmarks : Open "' +
				(bookmark.title === ''? bookmark.url: bookmark.title) + '"'
		};
	});
	suggest(result);
});

chrome.omnibox.onInputEntered.addListener(function(text){
	if(!text)
		return;
	var bookmark = search(text)[0];
	if(bookmark){
		chrome.tabs.getSelected(null, function(tab){
			chrome.tabs.update(tab.id, {
				url: bookmark.url,
				selected: true
			});
		});
	}else{
		chrome.tabs.getSelected(null, function(tab){
			chrome.tabs.update(tab.id, {
				url: 'http://www.google.com/search?btnI&q=' +
					encodeURIComponent(text),
				selected: true
			});
		});
	}
});


// オプションの初期化
var pref = new Preference({prefix: 'pref-'});

pref.setDefault('open-in', '2');
pref.setDefault('font-family', 'sans-serif');
pref.setDefault('icon-size', '16');
pref.setDefault('hide-other-bookmarks', true);
pref.setDefault('hide-other-bookmarks-if-empty', true);
pref.setDefault('search-box-enabled', false);

pref.addListener(function(key, value){
	var event = document.createEvent('Event');
	event.initEvent('pref-changed', false, false)
	event.key = key;
	event.value = value;

	chrome.extension.getViews().forEach(function(view){
		view.dispatchEvent(event);
	});
});

</script>
</head>
<body>
</body>
</html>
